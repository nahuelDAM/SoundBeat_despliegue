import{a as P}from"./chunk-3J7GGTVR.js";import{a as f}from"./chunk-BNQ67AVA.js";import{d,f as c,r as b,s as g}from"./chunk-XCE7OHUN.js";import{a as S,d as u}from"./chunk-CKJMNUPD.js";import{f as m}from"./chunk-RW4GY4BD.js";function v(s){s.CapacitorUtils.Synapse=new Proxy({},{get(n,p){return new Proxy({},{get(t,e){return(r,a,i)=>{let o=s.Capacitor.Plugins[p];if(o===void 0){i(new Error(`Capacitor plugin ${p} not found`));return}if(typeof o[e]!="function"){i(new Error(`Method ${e} not found in Capacitor plugin ${p}`));return}m(this,null,function*(){try{let l=yield o[e](r);a(l)}catch(l){i(l)}})}}})}})}function x(s){s.CapacitorUtils.Synapse=new Proxy({},{get(n,p){return s.cordova.plugins[p]}})}function E(s=!1){window.CapacitorUtils=window.CapacitorUtils||{},window.Capacitor!==void 0&&!s?v(window):window.cordova!==void 0&&x(window)}var y=S("Filesystem",{web:()=>import("./chunk-6IUJOI2C.js").then(s=>new s.FilesystemWeb)});E();var j=(()=>{let n=class n{constructor(){this.baseUrl=`${f.URLbase}/api/samples`}obtenerSamplesPorInstrumento(t,e=0,r=10,a="nombre",i="asc"){let o=`${this.baseUrl}/instrumento/${t}?page=${e}&size=${r}&sortBy=${a}&sortDirection=${i}`;return c(u.get({url:o,headers:this._getAuthHeaders()}).then(l=>l.data))}obtenerSamplesPorGenero(t,e=0,r=10,a="nombre",i="asc"){let o=`${this.baseUrl}/genero/${t}?page=${e}&size=${r}&sortBy=${a}&sortDirection=${i}`;return c(u.get({url:o,headers:this._getAuthHeaders()}).then(l=>l.data))}obtenerSamplesPorGeneroYTipo(t,e,r=0,a=10,i="nombre",o="asc"){let l=`${this.baseUrl}/genero/${t}/tipo/${e}?page=${r}&size=${a}&sortBy=${i}&sortDirection=${o}`;return c(u.get({url:l,headers:this._getAuthHeaders()}).then(h=>h.data))}obtenerSamplesPorInstrumentoYTipo(t,e,r=0,a=10,i="nombre",o="asc"){let l=`${this.baseUrl}/genero/${t}/tipo/${e}?page=${r}&size=${a}&sortBy=${i}&sortDirection=${o}`;return c(u.get({url:l,headers:this._getAuthHeaders()}).then(h=>h.data))}buscarSamples(t,e,r,a=0,i=10,o="nombre",l="asc"){let h=`${this.baseUrl}/buscar?query=${encodeURIComponent(t)}&page=${a}&size=${i}&sortBy=${o}&sortDirection=${l}`;return e!==void 0&&(h+=`&generoId=${e}`),r!==void 0&&(h+=`&tipoId=${r}`),c(u.get({url:h,headers:this._getAuthHeaders()}).then($=>$.data))}obtenerSamplesMasPopulares(){let t=`${this.baseUrl}/populares`;return c(u.get({url:t,headers:this._getAuthHeaders()}).then(e=>e.data))}obtenerSamplesMasRecientes(){let t=`${this.baseUrl}/recientes`;return c(u.get({url:t,headers:this._getAuthHeaders()}).then(e=>e.data))}sanitizeFileName(t){let e=t.replace(/[\\/?%*:|"<>]/g,"_");return e=e.replace(/\s+/g," ").trim(),e}descargarSample(t){return m(this,null,function*(){let e=t.url,r=`${this.sanitizeFileName(t.nombre)}.${t.formato}`;if((yield y.requestPermissions()).publicStorage==="granted")console.log("Permiso de almacenamiento p\xFAblico concedido.");else throw new Error("Permiso de almacenamiento denegado o no concedido. No se puede descargar el archivo.");try{let{path:i}=yield y.downloadFile({url:e,path:r,directory:P.Documents,progress:!0});return console.log("Archivo descargado en:",i),Promise.resolve()}catch(i){console.error("Error al descargar el archivo:",i);let o="Hubo un error al descargar el archivo: ";return i&&typeof i=="object"&&"message"in i?o+=i.message:o+=String(i),Promise.reject(o)}})}registrarReproduccion(t){let e=`${this.baseUrl}/${t}/registrar-reproduccion`;return console.log("Registrando reproducci\xF3n para el sample con ID:",t),c(u.post({url:e,headers:this._getAuthHeaders()}).then(r=>r.data))}_getAuthHeaders(){let t=localStorage.getItem("token"),e={"Content-Type":"application/json"};return t&&(e.Authorization=`Bearer ${t}`),e}};n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"});let s=n;return s})();var F=(()=>{let n=class n{constructor(t){this.sampleService=t,this.currentSampleSubject=new d(null),this.isPlayingSubject=new d(!1),this.playbackProgressSubject=new d(0),this.currentPlaybackTimeSubject=new d(0),this.playlistSubject=new d([]),this.historialReproduccionSubject=new d([]),this.audioElement=null,this.currentSample$=this.currentSampleSubject.asObservable(),this.isPlaying$=this.isPlayingSubject.asObservable(),this.playbackProgress$=this.playbackProgressSubject.asObservable(),this.currentPlaybackTime$=this.currentPlaybackTimeSubject.asObservable(),this.playlist$=this.playlistSubject.asObservable(),this.historialReproduccion$=this.historialReproduccionSubject.asObservable(),this.updatePlaybackInfo=()=>{if(!this.audioElement)return;let e=this.audioElement.currentTime,r=this.audioElement.duration,a=e/r*100;this.currentPlaybackTimeSubject.next(e),this.playbackProgressSubject.next(a)},this.handleTrackEnd=()=>{this.playNext()},this.loadPlayerState(),this.loadHistorial()}get currentSample(){return this.currentSampleSubject.value}get isPlaying(){return this.isPlayingSubject.value}get playbackProgress(){return this.playbackProgressSubject.value}get currentPlaybackTime(){return this.currentPlaybackTimeSubject.value}get playlist(){return this.playlistSubject.value}get historialReproduccion(){return this.historialReproduccionSubject.value}playSample(t,e=[]){if(this.currentSample&&this.currentSample.id===t.id){this.togglePlayPause();return}this.audioElement&&(this.audioElement.pause(),this.audioElement.removeEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.removeEventListener("ended",this.handleTrackEnd)),this.currentSampleSubject.next(t),e.length>0&&this.playlistSubject.next(e),this.playbackProgressSubject.next(0),this.currentPlaybackTimeSubject.next(0),this.audioElement=new Audio(t.url),this.audioElement.addEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.addEventListener("ended",this.handleTrackEnd),this.audioElement.play().then(()=>{this.isPlayingSubject.next(!0),this.addToHistorial(t),this.savePlayerState()}).catch(r=>{console.error("Error al reproducir el audio:",r),this.isPlayingSubject.next(!1)}),t.id!=null?this.sampleService.registrarReproduccion(t.id).subscribe({next:r=>{console.log(`Reproducci\xF3n del sample ${t.id} registrada. Respuesta:`,r)},error:r=>{console.error(`Error al registrar la reproducci\xF3n del sample ${t.id}:`,r)}}):console.warn("No se pudo registrar la reproducci\xF3n: el ID del sample es nulo o indefinido.")}togglePlayPause(){!this.audioElement||!this.currentSample||(this.isPlaying?(this.audioElement.pause(),this.isPlayingSubject.next(!1)):this.audioElement.play().then(()=>{this.isPlayingSubject.next(!0)}).catch(t=>{console.error("Error al reproducir el audio:",t)}),this.savePlayerState())}playNext(){if(!this.currentSample)return;let t=this.playlist,e=t.findIndex(r=>{var a;return r.id===((a=this.currentSample)==null?void 0:a.id)});e!==-1&&e<t.length-1?this.playSample(t[e+1]):t.length>0&&this.playSample(t[0])}playPrevious(){if(!this.currentSample)return;let t=this.playlist,e=t.findIndex(r=>{var a;return r.id===((a=this.currentSample)==null?void 0:a.id)});e>0?this.playSample(t[e-1]):t.length>0&&this.playSample(t[t.length-1])}seekTo(t){if(!this.audioElement||!this.currentSample)return;let e=this.audioElement.duration,r=t/100*e;this.audioElement.currentTime=r,this.currentPlaybackTimeSubject.next(r),this.playbackProgressSubject.next(t)}stop(){this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0,this.isPlayingSubject.next(!1),this.playbackProgressSubject.next(0),this.currentPlaybackTimeSubject.next(0),this.savePlayerState())}addToHistorial(t){let e=[...this.historialReproduccion];e=e.filter(r=>r.id!==t.id),e.unshift(t),e.length>5&&(e=e.slice(0,5)),this.historialReproduccionSubject.next(e),localStorage.setItem("historialReproduccion",JSON.stringify(e))}loadHistorial(){let t=localStorage.getItem("historialReproduccion");if(t)try{let e=JSON.parse(t);this.historialReproduccionSubject.next(e)}catch(e){console.error("Error al cargar el historial de reproducci\xF3n:",e)}}resetState(){this.audioElement&&(this.audioElement.pause(),this.audioElement.removeEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.removeEventListener("ended",this.handleTrackEnd),this.audioElement.src="",this.audioElement=null),this.currentSampleSubject.next(null),this.isPlayingSubject.next(!1),this.playbackProgressSubject.next(0),this.currentPlaybackTimeSubject.next(0),this.playlistSubject.next([]),this.historialReproduccionSubject.next([]),console.log("PlayerService state has been reset.")}savePlayerState(){let t={currentSample:this.currentSample,isPlaying:this.isPlaying,currentTime:this.currentPlaybackTime,playlist:this.playlist};localStorage.setItem("playerState",JSON.stringify(t))}loadPlayerState(){let t=localStorage.getItem("playerState");if(t)try{let e=JSON.parse(t);e.currentSample&&(this.currentSampleSubject.next(e.currentSample),this.playlistSubject.next(e.playlist||[]),this.isPlayingSubject.next(!1),this.currentPlaybackTimeSubject.next(e.currentTime||0),this.audioElement=new Audio(e.currentSample.url),this.audioElement.currentTime=e.currentTime||0,this.audioElement.addEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.addEventListener("ended",this.handleTrackEnd))}catch(e){console.error("Error al cargar el estado del reproductor:",e)}}ngOnDestroy(){this.audioElement&&(this.audioElement.pause(),this.audioElement.removeEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.removeEventListener("ended",this.handleTrackEnd),this.audioElement=null)}};n.\u0275fac=function(e){return new(e||n)(g(j))},n.\u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"});let s=n;return s})();export{j as a,F as b};
