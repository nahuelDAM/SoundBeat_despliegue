import{b as c,c as S}from"./chunk-5NEJBAS5.js";import{d,f as u,r as m,s as b}from"./chunk-XCE7OHUN.js";var y=(()=>{let a=class a{constructor(){this.baseUrl=`${S.URLbase}/api/samples`}obtenerSamplesPorInstrumento(e,t=0,r=10,i="nombre",n="asc"){let o=`${this.baseUrl}/instrumento/${e}?page=${t}&size=${r}&sortBy=${i}&sortDirection=${n}`;return u(c.get({url:o,headers:this._getAuthHeaders()}).then(s=>s.data))}obtenerSamplesPorGenero(e,t=0,r=10,i="nombre",n="asc"){let o=`${this.baseUrl}/genero/${e}?page=${t}&size=${r}&sortBy=${i}&sortDirection=${n}`;return u(c.get({url:o,headers:this._getAuthHeaders()}).then(s=>s.data))}obtenerSamplesPorGeneroYTipo(e,t,r=0,i=10,n="nombre",o="asc"){let s=`${this.baseUrl}/genero/${e}/tipo/${t}?page=${r}&size=${i}&sortBy=${n}&sortDirection=${o}`;return u(c.get({url:s,headers:this._getAuthHeaders()}).then(l=>l.data))}obtenerSamplesPorInstrumentoYTipo(e,t,r=0,i=10,n="nombre",o="asc"){let s=`${this.baseUrl}/genero/${e}/tipo/${t}?page=${r}&size=${i}&sortBy=${n}&sortDirection=${o}`;return u(c.get({url:s,headers:this._getAuthHeaders()}).then(l=>l.data))}buscarSamples(e,t,r,i=0,n=10,o="nombre",s="asc"){let l=`${this.baseUrl}/buscar?query=${encodeURIComponent(e)}&page=${i}&size=${n}&sortBy=${o}&sortDirection=${s}`;return t!==void 0&&(l+=`&generoId=${t}`),r!==void 0&&(l+=`&tipoId=${r}`),u(c.get({url:l,headers:this._getAuthHeaders()}).then(p=>p.data))}obtenerSamplesMasPopulares(){let e=`${this.baseUrl}/populares`;return u(c.get({url:e,headers:this._getAuthHeaders()}).then(t=>t.data))}obtenerSamplesMasRecientes(){let e=`${this.baseUrl}/recientes`;return u(c.get({url:e,headers:this._getAuthHeaders()}).then(t=>t.data))}descargarSample(e){let t=`${this.baseUrl}/${e}/descargar`;return c.get({url:t,responseType:"blob",headers:this._getAuthHeaders()}).then(r=>{let i=new Blob([r.data],{type:r.headers["Content-Type"]||"application/octet-stream"}),n=r.headers["Content-Disposition"]||r.headers["content-disposition"],o="sample.mp3";if(n){let p=n.match(/filename="?([^"]+)"?/);p&&p[1]&&(o=decodeURIComponent(p[1]))}let s=document.createElement("a"),l=URL.createObjectURL(i);s.href=l,s.download=o,s.click(),URL.revokeObjectURL(l)}).catch(r=>{throw console.error("Error al descargar el sample:",r),new Error("No se pudo descargar el sample")})}registrarReproduccion(e){let t=`${this.baseUrl}/${e}/registrar-reproduccion`;return console.log("Registrando reproducci\xF3n para el sample con ID:",e),u(c.post({url:t,headers:this._getAuthHeaders()}).then(r=>r.data))}_getAuthHeaders(){let e=localStorage.getItem("token"),t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t}};a.\u0275fac=function(t){return new(t||a)},a.\u0275prov=m({token:a,factory:a.\u0275fac,providedIn:"root"});let h=a;return h})();var k=(()=>{let a=class a{constructor(e){this.sampleService=e,this.currentSampleSubject=new d(null),this.isPlayingSubject=new d(!1),this.playbackProgressSubject=new d(0),this.currentPlaybackTimeSubject=new d(0),this.playlistSubject=new d([]),this.historialReproduccionSubject=new d([]),this.audioElement=null,this.currentSample$=this.currentSampleSubject.asObservable(),this.isPlaying$=this.isPlayingSubject.asObservable(),this.playbackProgress$=this.playbackProgressSubject.asObservable(),this.currentPlaybackTime$=this.currentPlaybackTimeSubject.asObservable(),this.playlist$=this.playlistSubject.asObservable(),this.historialReproduccion$=this.historialReproduccionSubject.asObservable(),this.updatePlaybackInfo=()=>{if(!this.audioElement)return;let t=this.audioElement.currentTime,r=this.audioElement.duration,i=t/r*100;this.currentPlaybackTimeSubject.next(t),this.playbackProgressSubject.next(i)},this.handleTrackEnd=()=>{this.playNext()},this.loadPlayerState(),this.loadHistorial()}get currentSample(){return this.currentSampleSubject.value}get isPlaying(){return this.isPlayingSubject.value}get playbackProgress(){return this.playbackProgressSubject.value}get currentPlaybackTime(){return this.currentPlaybackTimeSubject.value}get playlist(){return this.playlistSubject.value}get historialReproduccion(){return this.historialReproduccionSubject.value}playSample(e,t=[]){if(this.currentSample&&this.currentSample.id===e.id){this.togglePlayPause();return}this.audioElement&&(this.audioElement.pause(),this.audioElement.removeEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.removeEventListener("ended",this.handleTrackEnd)),this.currentSampleSubject.next(e),t.length>0&&this.playlistSubject.next(t),this.playbackProgressSubject.next(0),this.currentPlaybackTimeSubject.next(0),this.audioElement=new Audio(e.url),this.audioElement.addEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.addEventListener("ended",this.handleTrackEnd),this.audioElement.play().then(()=>{this.isPlayingSubject.next(!0),this.addToHistorial(e),this.savePlayerState()}).catch(r=>{console.error("Error al reproducir el audio:",r),this.isPlayingSubject.next(!1)}),e.id!=null?this.sampleService.registrarReproduccion(e.id).subscribe({next:r=>{console.log(`Reproducci\xF3n del sample ${e.id} registrada. Respuesta:`,r)},error:r=>{console.error(`Error al registrar la reproducci\xF3n del sample ${e.id}:`,r)}}):console.warn("No se pudo registrar la reproducci\xF3n: el ID del sample es nulo o indefinido.")}togglePlayPause(){!this.audioElement||!this.currentSample||(this.isPlaying?(this.audioElement.pause(),this.isPlayingSubject.next(!1)):this.audioElement.play().then(()=>{this.isPlayingSubject.next(!0)}).catch(e=>{console.error("Error al reproducir el audio:",e)}),this.savePlayerState())}playNext(){if(!this.currentSample)return;let e=this.playlist,t=e.findIndex(r=>{var i;return r.id===((i=this.currentSample)==null?void 0:i.id)});t!==-1&&t<e.length-1?this.playSample(e[t+1]):e.length>0&&this.playSample(e[0])}playPrevious(){if(!this.currentSample)return;let e=this.playlist,t=e.findIndex(r=>{var i;return r.id===((i=this.currentSample)==null?void 0:i.id)});t>0?this.playSample(e[t-1]):e.length>0&&this.playSample(e[e.length-1])}seekTo(e){if(!this.audioElement||!this.currentSample)return;let t=this.audioElement.duration,r=e/100*t;this.audioElement.currentTime=r,this.currentPlaybackTimeSubject.next(r),this.playbackProgressSubject.next(e)}stop(){this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0,this.isPlayingSubject.next(!1),this.playbackProgressSubject.next(0),this.currentPlaybackTimeSubject.next(0),this.savePlayerState())}addToHistorial(e){let t=[...this.historialReproduccion];t=t.filter(r=>r.id!==e.id),t.unshift(e),t.length>5&&(t=t.slice(0,5)),this.historialReproduccionSubject.next(t),localStorage.setItem("historialReproduccion",JSON.stringify(t))}loadHistorial(){let e=localStorage.getItem("historialReproduccion");if(e)try{let t=JSON.parse(e);this.historialReproduccionSubject.next(t)}catch(t){console.error("Error al cargar el historial de reproducci\xF3n:",t)}}resetState(){this.audioElement&&(this.audioElement.pause(),this.audioElement.removeEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.removeEventListener("ended",this.handleTrackEnd),this.audioElement.src="",this.audioElement=null),this.currentSampleSubject.next(null),this.isPlayingSubject.next(!1),this.playbackProgressSubject.next(0),this.currentPlaybackTimeSubject.next(0),this.playlistSubject.next([]),this.historialReproduccionSubject.next([]),console.log("PlayerService state has been reset.")}savePlayerState(){let e={currentSample:this.currentSample,isPlaying:this.isPlaying,currentTime:this.currentPlaybackTime,playlist:this.playlist};localStorage.setItem("playerState",JSON.stringify(e))}loadPlayerState(){let e=localStorage.getItem("playerState");if(e)try{let t=JSON.parse(e);t.currentSample&&(this.currentSampleSubject.next(t.currentSample),this.playlistSubject.next(t.playlist||[]),this.isPlayingSubject.next(!1),this.currentPlaybackTimeSubject.next(t.currentTime||0),this.audioElement=new Audio(t.currentSample.url),this.audioElement.currentTime=t.currentTime||0,this.audioElement.addEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.addEventListener("ended",this.handleTrackEnd))}catch(t){console.error("Error al cargar el estado del reproductor:",t)}}ngOnDestroy(){this.audioElement&&(this.audioElement.pause(),this.audioElement.removeEventListener("timeupdate",this.updatePlaybackInfo),this.audioElement.removeEventListener("ended",this.handleTrackEnd),this.audioElement=null)}};a.\u0275fac=function(t){return new(t||a)(b(y))},a.\u0275prov=m({token:a,factory:a.\u0275fac,providedIn:"root"});let h=a;return h})();export{y as a,k as b};
